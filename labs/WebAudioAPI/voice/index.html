<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>test</title>

    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <style>
        body {
            -webkit-text-size-adjust: 100%;
        }
    </style>
</head>
<body>

<h1>簡易ボイスチェンジャー</h1>

<button type="button" onclick="_clickOrg();">オリジナル音声</button>

<button type="button" onclick="_clickChg();">ボイスチェンジ</button>

<div>
    <p>音声ファイルは「あみたろの声素材工房」さんの声素材を使用させて頂きました。</p>
    <p>声素材の著作権は「あみたろの声素材工房」さんにあります。</p>
    <p><a href="http://www14.big.or.jp/~amiami/happy/">http://www14.big.or.jp/~amiami/happy/</a></p>
</div>

<script>

    // AudioContext確認
    function hasAudioContext() {
        return (window.AudioContext||window.webkitAudioContext);
    }


    if ( hasAudioContext() ){

        // Fix up prefixing
        window.AudioContext = window.AudioContext || window.webkitAudioContext;

        // audioインスタンス作成
        var _context = new AudioContext();

        var _source = null;
        var _buffer = null;

        var _gainNode = null;

        var _rate = 1;


        /**
         * 音声ファイル読み込み
         * @param url
         */
        function _loadSound(url) {
            var request = new XMLHttpRequest();
            request.open('GET', url, true);
            request.responseType = 'arraybuffer';

            // 読み込み完了
            request.onload = function() {

                if( this.readyState === 4 ) {
                    if( this.status === 200 ) {
                        // レスポンスデータをaudioデータにデコード
                        _context.decodeAudioData(this.response, function(buffer) {

                            // デコードデータを格納
                            _buffer = buffer;

                            // 再生開始
                            //_playSound( buffer );

                        }, _onErrorDecode);
                    } else {
                        alert("ERROE:読み込みに失敗しました");
                    }
                }
            }
            // 読み込み開始
            request.send();
        }

        /**
         * デコードERROR
         */
        function _onErrorDecode() {
            alert("ERROE:デコードに失敗しました");
        }

        /**
         * 再生開始
         * @param buffer
         * @private
         */
        function _playSound( buffer ) {

            // gainNodeを取得
            _gainNode = _context.createGain();

            // ソースを取得
            _source = _context.createBufferSource();

            // デコードデータを代入
            _source.buffer = buffer;

            // ソースと gain nodeを関連付ける
            _source.connect(_gainNode);

            // gain Node と Audioインスタンスを関連付ける
            _gainNode.connect(_context.destination);

            // ループ
            //_source.loop = true;

            _source.playbackRate.value = _rate;

            // 開始
            _source.start(0);
        }


        /**
         * 音量変更
         * @param element
         */
        function changeVolume(element) {
            var volume = parseInt(element.value) / parseInt(element.max);
            _gainNode.gain.value = volume;
        }
        /**
         * 再生速度変更
         * @param element
         */
        function changeRate(element) {
            var value = parseInt(element.value) / parseInt(element.max);

            _rate = 0.5 + value;
            _source.playbackRate.value = _rate;
        }



        // 読み込み開始
        _loadSound("hajimemasite_01.mp3");

    } else {
        alert("Web Audio APIに対応してません。");
    }



    function _clickOrg(){
        _rate = 1;
        _playSound( _buffer );
    }
    function _clickChg(){
        // 0.5 - 1.5
        _rate = 0.5 + Math.random();
        _playSound( _buffer );
    }


</script>

</body>
</html>
